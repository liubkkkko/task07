# Task 07: Azure Infrastructure with Terraform

This project implements the infrastructure for Task 07 using Terraform. The main objectives include:
- Setting up a resource group and base infrastructure
- Importing a manually created Storage Account into Terraform
- Configuring a CDN for the Storage Account
- Deploying a Linux VM with blobfuse for mounting an Azure Storage Container
- Setting up Recovery Services Vault for VM backup and restore operations
- Manually performing a VM backup and restore, and importing the restored VM into Terraform

## Prerequisites

Before running this project, ensure you have the following:
- **Terraform** installed (version `>= 1.5.7`)
- **Azure CLI** installed and authenticated
- A manually created Azure Storage Account for backend configuration

## Project Structure

The project directory is organized as follows:
```
.
├── azurerm_storage_account.sa
├── backend.tf
├── cdn.tf
├── cloud-init.txt
├── generated_resources.tf
├── imports.tf
├── outputs.tf
├── providers.tf
├── README.md
├── rg.tf
├── rsv.tf
├── sample.txt
├── sa.tf
├── terraform.tfstate
├── terraform.tfvars
├── variables.tf
└── vm.tf
```

## Implementation Steps

### 1. Configure Remote Backend

The remote backend is configured in `backend.tf` to store the Terraform state in a storage account created in Task 4:

```hcl
terraform {
  backend "azurerm" {
    resource_group_name  = "cmaz-13f58f43-mod4-rg"
    storage_account_name = "task04backendsa"
    container_name       = "terraform-state"
    key                  = "task07/terraform.tfstate"
  }
}
```

### 2. Initialize Terraform

Run the following command to initialize Terraform and download the necessary providers:

```bash
terraform init
```

### 3. Create the Resource Group

The resource group is created using the `rg.tf` file:

```hcl
resource "azurerm_resource_group" "rg" {
  name     = var.resource_group_name
  location = var.location

  tags = {
    Creator = var.creator_tag
  }
}
```

Apply the configuration:

```bash
terraform plan
terraform apply -auto-approve
```

### 4. Import the Storage Account

Manually create the Storage Account in the Azure Portal or using Azure CLI. Then, import it into Terraform:

```bash
terraform import azurerm_storage_account.sa /subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.Storage/storageAccounts/<storage_account_name>
```

This allows Terraform to manage the manually created Storage Account.
After this step, we deploy the rest of the infrastructure according to the task.

## Manual Backup and Restore of the VM

### 1. Backup the VM
1. Go to the Azure Portal
2. Navigate to the Recovery Services Vault
3. Select the VM and trigger a manual backup

### 2. Restore the VM
1. In the Azure Portal, navigate to the Recovery Services Vault
2. Select the backup item and restore the VM to a new instance
3. Note the resource IDs of the restored resources (VM, NIC, Public IP, Managed Disk)

## Importing Restored Resources

### 1. Add Import Commands

Add the following commands to `imports.tf` to import the restored resources:

```hcl
# Import the restored VM
import {
  to = azurerm_virtual_machine.restored_vm
  id = "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>"
}

# Import the restored NIC
import {
  to = azurerm_network_interface.restored_vm_nic
  id = "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.Network/networkInterfaces/<nic_name>"
}

# Import the restored Public IP
import {
  to = azurerm_public_ip.restored_vm_pip
  id = "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.Network/publicIPAddresses/<pip_name>"
}

# Import the restored Managed Disk
import {
  to = azurerm_managed_disk.restored_vm_disk
  id = "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>/providers/Microsoft.Compute/disks/<disk_name>"
}
```

Execute the imports:

```bash
terraform plan -generate-config-out=generated_resources.tf
```

### 2. Review Generated Configuration

Review the autogenerated configuration in `generated_resources.tf`. Move the relevant code to `vm.tf` and update it as needed.

## Contact

For any questions or issues, please contact liubomyr_puliak@epam.com